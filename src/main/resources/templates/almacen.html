<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Almacén - Componentes Disponibles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">

    <style>
        /* F1 DIGITAL HUD THEME */
        :root {
            --f1-red: #FF2A2A;
            --carbon-dark: #0F0F0F;
            --carbon-light: #1A1A1A;
            --accent-blue: #00BFFF;
        }
        body {
            background-color: var(--carbon-dark);
            color: #EAEAEA;
            font-family: 'Inter', sans-serif;
            padding-top: 70px;
        }
        .text-f1-red { color: var(--f1-red); }
        .bg-f1-red { background-color: var(--f1-red); }
        .border-f1-red { border-color: var(--f1-red) !important; }
        .text-accent-blue { color: var(--accent-blue); }
        .bg-accent-blue { background-color: var(--accent-blue); }

        /* Estilos de Tarjeta de Componente */
        .card-f1 {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background-color: var(--carbon-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-f1:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7), 0 0 15px rgba(0, 191, 255, 0.4); /* Glow Cian */
            border-color: var(--accent-blue) !important;
        }
        .input-group-text, .form-control {
            background-color: var(--carbon-light) !important;
            color: #EAEAEA !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        .input-group-text.bg-f1-red { background-color: var(--f1-red) !important; color: var(--carbon-dark) !important; }
        .input-group-text.bg-accent-blue { background-color: var(--accent-blue) !important; color: var(--carbon-dark) !important; }

        /* Estilo de la barra de progreso (Uso) */
        .progress-bar-usage {
            transition: width 0.6s ease;
        }
    </style>
</head>

<body>

<!-- Navbar F1 Style -->
<nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow-lg border-bottom border-f1-red">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold text-f1-red fs-4" href="#">
            <i class="bi bi-speedometer2 me-2"></i>
            ESCUDERÍA SIM
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link fw-semibold text-white-50" th:href="@{/dashboard}">DASHBOARD</a></li>
                <li class="nav-item"><a class="nav-link fw-semibold text-white-50" th:href="@{/garaje}">GARAJE</a></li>
                <li class="nav-item"><a class="nav-link active fw-semibold text-accent-blue border-bottom border-accent-blue" aria-current="page" th:href="@{/almacen}">ALMACÉN</a></li>
                <li class="nav-item"><a class="nav-link fw-semibold text-white-50" th:href="@{/carreras}">CARRERAS</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid py-5 mt-5">

    <!-- Título principal -->
    <div class="text-center mb-5 animate__animated animate__fadeInDown">
        <h1 class="display-3 fw-bold text-white mb-3">
            <i class="bi bi-box-seam-fill text-f1-red"></i> <span class="text-accent-blue">INVENTARIO</span> DE PIEZAS
        </h1>
        <div class="bg-f1-red mx-auto mb-3 rounded" style="height: 4px; width: 150px;"></div>
        <p class="lead text-light-50">Gestiona y organiza todos los componentes disponibles</p>
    </div>

    <!-- Panel de Filtros y Búsqueda -->
    <div class="row mb-5 animate__animated animate__fadeInUp">
        <div class="col-12">
            <div class="card bg-carbon-light border-accent-blue shadow-2xl rounded-4">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-4 text-accent-blue border-bottom border-f1-red pb-2">
                        <i class="bi bi-funnel-fill me-2"></i>
                        FILTROS Y BÚSQUEDA
                    </h5>

                    <div class="row g-3">
                        <!-- Búsqueda por nombre -->
                        <div class="col-md-4">
                            <form th:action="@{/almacen/buscarNombre}" method="post" class="d-flex gap-2">
                                <div class="input-group">
                                        <span class="input-group-text bg-f1-red text-dark border-f1-red">
                                            <i class="bi bi-search"></i>
                                        </span>
                                    <input type="text"
                                           name="nombre"
                                           class="form-control"
                                           placeholder="Buscar por nombre..."
                                           th:value="${nombreBuscado}">
                                    <button type="submit" class="btn bg-f1-red text-dark fw-bold">
                                        Buscar
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Filtrar por tipo -->
                        <div class="col-md-4">
                            <form th:action="@{/almacen/filtrar/tipo}" method="post">
                                <div class="input-group">
                                        <span class="input-group-text bg-accent-blue text-dark border-accent-blue">
                                            <i class="bi bi-filter"></i>
                                        </span>
                                    <select name="tipo" class="form-select" onchange="this.form.submit()">
                                        <option value="">Filtrar por tipo...</option>
                                        <option value="MOTOR">MOTOR</option>
                                        <option value="TURBO">TURBO</option>
                                        <option value="BATERIA">BATERÍA</option>
                                        <option value="CAJA_DE_CAMBIOS">CAJA DE CAMBIOS</option>
                                        <option value="NEUMATICOS">NEUMÁTICOS</option>
                                        <option value="ALERON">ALERÓN</option>
                                        <option value="PARAGOLPES">PARAGOLPES</option>
                                        <option value="SUSPENSION">SUSPENSIÓN</option>
                                        <option value="DIRECCION">DIRECCIÓN</option>
                                    </select>
                                </div>
                            </form>
                        </div>

                        <!-- Ordenar -->
                        <div class="col-md-4">
                            <div class="btn-group w-100 shadow-sm" role="group">
                                <form th:action="@{/almacen/ordenarUsosMenor}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-success" data-bs-toggle="tooltip" title="Menos usado primero">
                                        <i class="bi bi-sort-down"></i> Menos Usos
                                    </button>
                                </form>
                                <form th:action="@{/almacen/ordenarUsosMayor}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-f1-red border-f1-red text-f1-red" data-bs-toggle="tooltip" title="Más usado primero">
                                        <i class="bi bi-sort-up"></i> Más Usos
                                    </button>
                                </form>
                                <form th:action="@{/almacen/mejores}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-accent-blue border-accent-blue text-accent-blue" data-bs-toggle="tooltip" title="Mejores componentes">
                                        <i class="bi bi-trophy-fill"></i> TOP
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Botón limpiar filtros -->
                    <div class="row mt-3">
                        <div class="col-12 text-end">
                            <a th:href="@{/almacen}" class="btn btn-sm btn-outline-light">
                                <i class="bi bi-x-circle"></i> Limpiar Filtros
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas: Usando acentos Cian y Rojo -->
    <div class="row g-4 mb-5 animate__animated animate__fadeInUp animate__delay-1s">
        <div class="col-md-3">
            <div class="card bg-black border-accent-blue shadow-lg h-100 card-f1">
                <div class="card-body text-center p-4">
                    <div class="bg-accent-blue text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                        <i class="bi bi-box-seam fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-1 text-accent-blue" th:text="${componentes != null ? componentes.size() : 0}">0</h3>
                    <p class="text-light-50 mb-0 small">TOTAL INVENTARIO</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-black border-success shadow-lg h-100 card-f1">
                <div class="card-body text-center p-4">
                    <div class="bg-success text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                        <i class="bi bi-check-circle fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-1 text-success" th:text="${componentesSinCoche != null ? componentesSinCoche.size() : 0}">0</h3>
                    <p class="text-light-50 mb-0 small">DISPONIBLES</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-black border-f1-red shadow-lg h-100 card-f1">
                <div class="card-body text-center p-4">
                    <div class="bg-f1-red text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                        <i class="bi bi-gear-fill fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-1 text-f1-red" th:text="${componentes != null ? (componentes.size() - (componentesSinCoche != null ? componentesSinCoche.size() : 0)) : 0}">0</h3>
                    <p class="text-light-50 mb-0 small">EN USO</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-black border-info shadow-lg h-100 card-f1">
                <div class="card-body text-center p-4">
                    <div class="bg-info text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                        <i class="bi bi-layers-fill fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-1 text-info" th:text="${tipos != null ? tipos.size() : 0}">0</h3>
                    <p class="text-light-50 mb-0 small">TIPOS DIFERENTES</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta cuando no hay componentes -->
    <div th:if="${#lists.isEmpty(componentes)}" class="alert border-f1-red bg-carbon-light shadow-sm text-center py-5 mb-5 animate__animated animate__shakeX">
        <i class="bi bi-inbox text-f1-red" style="font-size: 5rem;"></i>
        <h4 class="mt-3 text-white">EL ALMACÉN ESTÁ VACÍO</h4>
        <p class="text-light-50">¡Es hora de comprar nuevos componentes para tu escudería!</p>
    </div>

    <!-- Lista de componentes -->
    <div th:unless="${#lists.isEmpty(componentes)}">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-accent-blue fw-bold">
                <i class="bi bi-card-list"></i>
                INVENTARIO
                <span class="badge bg-f1-red text-dark" th:text="${componentes.size()}">0</span>
            </h3>
            <div class="btn-group shadow-sm" role="group">
                <button type="button" class="btn bg-f1-red text-dark active" id="gridView">
                    <i class="bi bi-grid-3x3-gap-fill"></i> Grid
                </button>
                <button type="button" class="btn btn-outline-f1-red border-f1-red text-f1-red" id="listView">
                    <i class="bi bi-list-ul"></i> Lista
                </button>
            </div>
        </div>

        <div class="row g-4 animate__animated animate__fadeInUp" id="componentesContainer">
            <div class="col-sm-6 col-md-4 col-lg-3 componente-item" th:each="comp : ${componentes}">
                <div class="card card-f1 h-100 shadow-lg rounded-3">

                    <!-- Header del componente -->
                    <div class="card-header border-f1-red p-3 border-bottom"
                         th:classappend="${comp.coche != null} ? 'bg-f1-red text-dark fw-bold' : 'bg-carbon-light text-white'">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                    <span class="badge rounded-pill mb-2"
                                          th:classappend="${comp.coche != null} ? 'bg-dark text-f1-red' : 'bg-success text-dark'">
                                        <i th:class="${comp.coche != null ? 'bi bi-x-circle-fill' : 'bi bi-check-circle-fill'}"></i>
                                        <span th:text="${comp.coche != null ? 'EN USO' : 'DISPONIBLE'}"></span>
                                    </span>
                                <h6 class="fw-bold mb-0 text-uppercase" th:text="${comp.tipo}" th:classappend="${comp.coche != null ? 'text-dark' : 'text-accent-blue'}">Tipo</h6>
                            </div>
                            <small class="badge bg-accent-blue text-dark rounded-pill">ID: <span th:text="${comp.id}"></span></small>
                        </div>
                    </div>

                    <!-- Body del componente -->
                    <div class="card-body p-3">
                        <h5 class="card-title fw-bold text-accent-blue mb-3" th:text="${comp.nombre}">Nombre</h5>

                        <!-- Info rápida -->
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="bg-black border border-accent-blue rounded-3 p-2 text-center">
                                    <i class="bi bi-speedometer text-accent-blue"></i>
                                    <div class="fw-bold small text-light" th:text="${comp.caballos} + ' CV'">0 CV</div>
                                    <small class="text-muted" style="font-size: 0.7rem;">Potencia</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-black border border-f1-red rounded-3 p-2 text-center">
                                    <i class="bi bi-activity text-f1-red"></i>
                                    <div class="fw-bold small text-light" th:text="${#numbers.formatDecimal(comp.estado, 0, 0)} + '%'">100%</div>
                                    <small class="text-muted" style="font-size: 0.7rem;">Estado</small>
                                </div>
                            </div>
                        </div>

                        <!-- Si está en uso -->
                        <div th:if="${comp.coche != null}" class="alert bg-f1-red text-dark p-2 mb-3 small border-0 rounded-3 fw-bold">
                            <i class="bi bi-car-front-fill"></i>
                            **INSTALADO EN:** <span th:text="${comp.coche.modelo}"></span>
                        </div>

                        <!-- Usos restantes -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-light fw-semibold">
                                    <i class="bi bi-clock-history text-accent-blue"></i> USOS (VIDA)
                                </small>
                                <small class="fw-bold"
                                       th:classappend="${(comp.vecesUsado / comp.limiteUsos) >= 0.8} ? 'text-f1-red' : (${(comp.vecesUsado / comp.limiteUsos) >= 0.5} ? 'text-warning' : 'text-success')">
                                    <span th:text="${comp.vecesUsado}">0</span>/<span th:text="${comp.limiteUsos}">0</span>
                                </small>
                            </div>
                            <div class="progress rounded-pill bg-black" style="height: 8px;">
                                <div class="progress-bar progress-bar-usage rounded-pill"
                                     th:classappend="${(comp.vecesUsado / comp.limiteUsos) >= 0.8} ? 'bg-f1-red' : (${(comp.vecesUsado / comp.limiteUsos) >= 0.5} ? 'bg-warning' : 'bg-success')"
                                     role="progressbar"
                                     th:style="'width: ' + ((${comp.vecesUsado} * 100) / ${comp.limiteUsos}) + '%'">
                                </div>
                            </div>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                <span th:text="${comp.limiteUsos - comp.vecesUsado}">0</span> usos restantes
                            </small>
                        </div>
                    </div>

                    <!-- Footer con acción -->
                    <div class="card-footer bg-black border-accent-blue p-3 border-top">
                        <a th:href="@{/almacen/componente/{id}(id=${comp.id})}"
                           class="btn btn-outline-accent-blue w-100 rounded-3 fw-bold text-uppercase">
                            <i class="bi bi-eye"></i> VER DETALLES
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Footer -->
<footer class="bg-black text-f1-red text-center py-4 mt-5 shadow-lg border-top border-f1-red">
    <div class="container">
        <p class="mb-0">
            <i class="bi bi-box-seam"></i>
            <strong>ALMACÉN F1</strong> - Sistema de Inventario
        </p>
        <small class="text-muted">Powered by Bootstrap 5</small>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Lógica para cambiar vista Grid/Lista
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');
    const container = document.getElementById('componentesContainer');

    function updateView(isList) {
        if (isList) {
            container.classList.remove('row', 'g-4');
            container.classList.add('d-flex', 'flex-column', 'gap-3');
            document.querySelectorAll('.componente-item').forEach(item => {
                item.classList.remove('col-sm-6', 'col-md-4', 'col-lg-3');
                item.classList.add('w-100');
            });

            listView.classList.add('active', 'bg-f1-red', 'text-dark');
            listView.classList.remove('btn-outline-f1-red', 'text-f1-red');

            gridView.classList.remove('active', 'bg-f1-red', 'text-dark');
            gridView.classList.add('btn-outline-f1-red', 'text-f1-red');
        } else {
            container.classList.add('row', 'g-4');
            container.classList.remove('d-flex', 'flex-column', 'gap-3');
            document.querySelectorAll('.componente-item').forEach(item => {
                item.classList.add('col-sm-6', 'col-md-4', 'col-lg-3');
                item.classList.remove('w-100');
            });

            gridView.classList.add('active', 'bg-f1-red', 'text-dark');
            gridView.classList.remove('btn-outline-f1-red', 'text-f1-red');

            listView.classList.remove('active', 'bg-f1-red', 'text-dark');
            listView.classList.add('btn-outline-f1-red', 'text-f1-red');
        }
    }

    // Inicializar la vista en Grid por defecto y añadir listeners
    updateView(false);
    gridView?.addEventListener('click', () => updateView(false));
    listView?.addEventListener('click', () => updateView(true));
</script>
</body>
</html>